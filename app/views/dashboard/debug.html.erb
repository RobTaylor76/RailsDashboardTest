<% content_for :title, "Dashboard Debug" %>

<div id="dashboard-content" data-dashboard-target="content">
  <div class="dashboard-header">
    <h2>Dashboard Debug Information</h2>
    <p class="dashboard-subtitle">Troubleshooting auto-refresh issues</p>
    <div class="auto-refresh-indicator" id="auto-refresh-status">
      <span class="status-dot"></span>
      <span class="status-text">Auto-refresh active</span>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="dashboard-card">
      <div class="card-header">
        <h3>Server Information</h3>
      </div>
      <div class="card-content">
        <div class="metric-item">
          <span class="label">Current Time:</span>
          <span class="value"><%= @debug_info[:current_time] %></span>
        </div>
        <div class="metric-item">
          <span class="label">System Status Updated:</span>
          <span class="value"><%= @debug_info[:system_status] %></span>
        </div>
        <div class="metric-item">
          <span class="label">Metrics Count:</span>
          <span class="value"><%= @debug_info[:metrics_count] %></span>
        </div>
        <div class="metric-item">
          <span class="label">Activities Count:</span>
          <span class="value"><%= @debug_info[:activities_count] %></span>
        </div>
        <div class="metric-item">
          <span class="label">Jobs Running:</span>
          <span class="value"><%= @debug_info[:jobs_running] ? "Yes" : "No" %></span>
        </div>
        <div class="metric-item">
          <span class="label">Pub/Sub Backend:</span>
          <span class="value"><%= @debug_info[:pubsub_backend] || "Not configured" %></span>
        </div>
        <div class="metric-item">
          <span class="label">Pub/Sub Events:</span>
          <span class="value"><%= @debug_info[:pubsub_events_count] || 0 %></span>
        </div>
      </div>
    </div>

    <div class="dashboard-card">
      <div class="card-header">
        <h3>JavaScript Debug</h3>
      </div>
      <div class="card-content">
        <div class="metric-item">
          <span class="label">Stimulus Connected:</span>
          <span class="value" id="stimulus-status">Checking...</span>
        </div>
        <div class="metric-item">
          <span class="label">Auto-refresh Timer:</span>
          <span class="value" id="timer-status">Checking...</span>
        </div>
        <div class="metric-item">
          <span class="label">Last Refresh:</span>
          <span class="value" id="last-refresh-time">Never</span>
        </div>
        <div class="metric-item">
          <span class="label">Console Messages:</span>
          <span class="value">Check browser console (F12)</span>
        </div>
      </div>
    </div>

    <div class="dashboard-card">
      <div class="card-header">
        <h3>Pub/Sub System</h3>
      </div>
      <div class="card-content">
        <div class="metric-item">
          <span class="label">SSE Connections:</span>
          <span class="value"><%= @debug_info[:sse_connections]&.dig(:total_connections) || 0 %></span>
        </div>
        <div class="metric-item">
          <span class="label">Active Connections:</span>
          <span class="value"><%= @debug_info[:sse_connections]&.dig(:connections)&.length || 0 %></span>
        </div>
        <div class="metric-item">
          <span class="label">Redis Status:</span>
          <span class="value"><%= @debug_info[:pubsub_backend] == :redis ? "Connected" : "Not available" %></span>
        </div>
        <div class="metric-item">
          <span class="label">Database Events:</span>
          <span class="value"><%= @debug_info[:pubsub_events_count] || 0 %></span>
        </div>
      </div>
    </div>
  </div>

  <div class="dashboard-footer-info">
    <p>This page helps debug auto-refresh issues</p>
    <p>Open browser console (F12) to see debug messages</p>
    <p>Last page load: <%= Time.current.strftime("%H:%M:%S") %></p>
  </div>
</div>

<script>
// Simple JavaScript test
document.addEventListener('DOMContentLoaded', function() {
  console.log('ðŸ” Debug page loaded');
  
  // Update status indicators
  document.getElementById('stimulus-status').textContent = 'Page loaded';
  
  // Test if Stimulus is working
  if (window.Stimulus) {
    document.getElementById('stimulus-status').textContent = 'Stimulus available';
  }
  
  // Test timer
  let timerCount = 0;
  const timerInterval = setInterval(() => {
    timerCount++;
    document.getElementById('timer-status').textContent = `Running (${timerCount}s)`;
    
    if (timerCount >= 30) {
      clearInterval(timerInterval);
      document.getElementById('timer-status').textContent = '30s elapsed';
    }
  }, 1000);
});
</script> 